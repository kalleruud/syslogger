services:
  syslogger:
    build:
      context: .
      dockerfile: Dockerfile
    image: syslogger:latest
    container_name: syslogger
    restart: unless-stopped

    ports:
      # Web UI and API
      - '3791:3791'
      # Syslog UDP port
      - '5140:5140/udp'

    volumes:
      # Persist SQLite database
      - ./data:/usr/src/app/data
      # Optional: Mount custom config (if needed in future)
      # - ./config:/usr/src/app/config:ro

    environment:
      # Node environment
      NODE_ENV: production

      # HTTP server configuration
      SYSLOGGER_PORT: 3791

      # Syslog UDP configuration
      SYSLOGGER_SYSLOG_PORT: 5140
      SYSLOGGER_SYSLOG_PROTOCOL: udp

      # Database configuration
      SYSLOGGER_DB_URL: ./data/syslogger.db

      # CORS configuration
      SYSLOGGER_CORS_ORIGIN: '*'

      # Timezone configuration (adjust as needed)
      TZ: UTC

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

    # Logging configuration
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

    # Health check (runs inside container, not affected by external domain)
    healthcheck:
      test:
        [
          'CMD',
          'bun',
          '-e',
          "fetch('http://127.0.0.1:3791/').then(() => process.exit(0)).catch(() => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
# Create named volume for data persistence (optional alternative to bind mount)
# volumes:
#   syslogger-data:
